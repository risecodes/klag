name: Docker Build & Deploy to Artifact Registry

on:
  push:
    branches:
      - main

env:
  GCP_PROJECT: prog-production
  GAR_REGION: us-east4
  IMAGE_NAME: klag

jobs:
  build-and-push:
    runs-on:
      group: productionArmGCP
    permissions:
      id-token: write
      contents: read
    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4
      - name: üîë Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/294225887853/locations/global/workloadIdentityPools/github/providers/github
          service_account: github-sa@global-mgmt.iam.gserviceaccount.com
      - name: ‚öôÔ∏è Set up GCloud and Configure Docker
        uses: google-github-actions/setup-gcloud@v2
      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.GAR_REGION }}-docker.pkg.dev --quiet
      # --- Build and Push ---
      - name: üèóÔ∏è Build and Push Docker Image
        # Define the full image path using the configured variables
        run: |
          GAR_HOST="${{ env.GAR_REGION }}-docker.pkg.dev"
          FULL_IMAGE_PATH="${GAR_HOST}/prog-production/us-east4/${{ env.IMAGE_NAME }}"
          IMAGE_TAG="${{ github.sha }}"

          echo "Building image: $FULL_IMAGE_PATH:$IMAGE_TAG"

          # Build the image and tag it with the commit SHA
          docker build -t "$FULL_IMAGE_PATH:$IMAGE_TAG" .

          echo "Pushing $FULL_IMAGE_PATH:$IMAGE_TAG to Artifact Registry..."
          # Push the SHA-tagged image
          docker push "$FULL_IMAGE_PATH:$IMAGE_TAG"

          # Tag and push 'latest'
          docker tag "$FULL_IMAGE_PATH:$IMAGE_TAG" "$FULL_IMAGE_PATH:latest"
          docker push "$FULL_IMAGE_PATH:latest"

#  commit_to_repo:
#    runs-on: ubuntu-latest
#    needs:
#      - build-and-push
#    steps:
#      - name: ‚¨áÔ∏è Checkout Repository
#        uses: actions/checkout@v4
#      - name: üìù Update values.yaml
#        # Use YQ to set the new version in the values.yaml file
#        run: |
#          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.40.5/yq_linux_amd64
#          sudo chmod a+x /usr/local/bin/yq
#          yq -i '.image.tag = "${{ github.sha }}"' ./chart/values.yaml
#          echo "Updated values.yaml with version ${{ github.sha }}"
#
#      - name: üíæ Commit Updated Helm Values
#        run: |
#          git config user.name ci-cd-user
#          git config user.email ci-cd-user@risecodes.com
#          git add ./chart/values.yaml
#          # CRITICAL CHANGE: Added [skip ci] to the commit message
#          git commit -m "chore(helm): Update Benthos image tag to ${{ github.sha }} [skip ci]" || echo "No changes to commit"
#          REPO_URL="https://x-access-token:${{ secrets.ACCESS_TOKEN_GITHUB }}@github.com/${{ github.repository }}.git"
#          git push $REPO_URL
